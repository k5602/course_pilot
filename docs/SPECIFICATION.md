# Functional and Technical Specification

## 1. Data Schema (Diesel / SQLite)

The database is designed to enforce a structured learning path. Every entity relates back to the goal of course completion.

### `courses`

| Column        | Type      | Description                   |
| :------------ | :-------- | :---------------------------- |
| `id`          | Uuid      | Primary Key                   |
| `name`        | Text      | Cleaned course title          |
| `source_url`  | Text      | Original YouTube playlist URL |
| `playlist_id` | Text      | Extracted YouTube ID          |
| `description` | Text      | Optional course overview      |
| `created_at`  | Timestamp | Date added to sanctuary       |

### `modules`

| Column       | Type    | Description                    |
| :----------- | :------ | :----------------------------- |
| `id`         | Uuid    | Primary Key                    |
| `course_id`  | Uuid    | Foreign Key to `courses`       |
| `title`      | Text    | AI or ML generated module name |
| `sort_order` | Integer | Position within the course     |

### `videos`

| Column          | Type    | Description                |
| :-------------- | :------ | :------------------------- |
| `id`            | Uuid    | Primary Key                |
| `module_id`     | Uuid    | Foreign Key to `modules`   |
| `youtube_id`    | Text    | YouTube video identifier   |
| `title`         | Text    | Sanitized video title      |
| `duration_secs` | Integer | Length of video            |
| `is_completed`  | Boolean | Binary completion status   |
| `sort_order`    | Integer | Position within the module |

### `exams`

| Column          | Type    | Description                      |
| :-------------- | :------ | :------------------------------- |
| `id`            | Uuid    | Primary Key                      |
| `video_id`      | Uuid    | Link to the validated video      |
| `question_json` | Text    | The MCQ data generated by Gemini |
| `score`         | Float   | User's performance (0.0 - 1.0)   |
| `passed`        | Boolean | Based on a 70% threshold         |

---

## 2. Core Feature Behaviors

### 2.1 The "Structure from Chaos" Ingestion

1. **Extraction**: Fetch all video titles and metadata from a YouTube playlist.
2. **Title Sanitization**: Remove noise (e.g., "Tutorial #1", "2024 Update", "!!!").
3. **Local Embedding**: Use `fastembed-rs` to generate a 384-dimension vector for each sanitized title.
4. **Segmental Clustering**: Perform order-preserving clustering locally.
   - **Order Preservation**: The original playlist sequence is strictly maintained. The system identifies "logical breakpoints" where topics shift without reordering.
   - **Boundary Detection**: Uses semantic similarity between adjacent videos to suggest module boundaries.
5. **Module Naming**: If local ML is insufficient, a single prompt to Gemini provides titles for these modules based on the grouped video names.

### 2.2 Cognitive Load & Session Planning

1. **Duration Analysis**: Total course length is analyzed to calculate optimal session durations.
2. **Session Suggestion**: The system suggests "Stop Points" based on accumulated duration and module boundaries to prevent learner fatigue.
3. **Dynamic Pacing**: Users can set their "Daily Cognitive Limit" (e.g., 45 minutes of content), and the roadmap segments into daily targets accordingly.

### 2.3 The Sidecar Companion (AI-B)

- **Trigger**: Active whenever a video is playing.
- **Context**: The LLM is fed the current video title, description, and the module structure.
- **Behavior**: User can ask for clarifications without leaving the player. Response must be concise and academic.

### 2.4 The Manual Examiner (AI-C)

- **Trigger**: User clicks "I have mastered this video."
- **Generation**: Gemini generates 3â€“5 Multiple Choice Questions (MCQ) in a strict JSON format.
- **Validation**:
  - If the user passes: `is_completed` is set to `true`.
  - If the user fails: The video remains "Pending" and a review session is suggested.

---

## 3. UI Requirements (Dioxus Desktop)

### Dashboard (The Library)

- High-level view of all courses.
- Progress indicated by "Modules Completed / Total Modules."
- Visual emphasis on "Distance to Finish" rather than "Time Spent."

### Sanctuary Player

- **Main View**: YouTube iFrame using the `youtube-nocookie.com` domain.
- **CSS Injection**: Disable "More Videos" and "YouTube Logo" overlays to prevent click-out.
- **Sidebar**: Toggleable view between "Course Roadmap" and "AI Companion."

---

## 4. Technical Constraints

- **Database**: Diesel 2.0+ for all migrations.
- **Error Handling**: `anyhow` for top-level app logic; custom `thiserror` for the ML and Ingestion crates.
- **Performance**: Clustering and Embedding must happen on a background thread to prevent UI blocking.
- **Security**: LLM API keys must never be hardcoded or committed to version control.

---

## 5. BYOK (Bring Your Own Key) Management

### 5.1 Storage Strategy

- **Platform Integration**: Use `keyring-rs` to leverage system-native credential stores (Windows Credential Manager, macOS Keychain, Linux Secret Service).
- **Fallback**: If no system keyring is available, store in an encrypted local configuration file (AES-256) with a user-defined master password.

### 5.2 Provider Support

- **Initial Provider**: Google Gemini (1.5 Flash).
- **Configuration**: Users must be able to input, validate, and rotate their API keys via a "Settings" modal.

### 5.3 Validation Workflow

1. User enters API Key.
2. App performs a minimal "smoke test" call (e.g., listing models) to verify the key.
3. Upon success, the key is persisted to the secure store.
4. Key is loaded into memory only when an AI-B or AI-C task is initiated.
