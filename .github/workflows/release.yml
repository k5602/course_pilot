name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: read

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  NODE_VERSION: "20"
  APP_NAME: course_pilot
  CARGO_INCREMENTAL: 0
  CARGO_NET_GIT_FETCH_WITH_CLI: "true"

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            artifact: course-pilot-linux-x64.tar.gz
            binary: course_pilot
          # - os: windows-2022
          #   platform: windows
          #   artifact: course-pilot-windows-x64.msi
          #   binary: course_pilot.exe

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Cargo git CLI
        run: |
          mkdir -p .cargo
          cat > .cargo/config.toml <<'EOF'
          [net]
          git-fetch-with-cli = true
          EOF
        shell: bash

      - name: Enable long paths (Windows)
        if: matrix.platform == 'windows'
        run: git config --system core.longpaths true
        shell: pwsh

      - name: Enable long paths in registry (Windows)
        if: matrix.platform == 'windows'
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\FileSystem' -Name 'LongPathsEnabled' -Value 1
        shell: pwsh

      - name: Install NASM (Windows)
        if: matrix.platform == 'windows'
        uses: ilammy/setup-nasm@v1

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.platform == 'windows' && 'x86_64-pc-windows-msvc' || '' }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libxdo3 \
            libxdo-dev \
            patchelf \
            pkg-config \
            libglib2.0-dev \
            libgdk-pixbuf2.0-dev \
            libcairo2-dev \
            libpango1.0-dev \
            libatk1.0-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev \
            libgdk3.0-cil
        shell: bash

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install Node dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
        shell: bash

      - name: Ensure assets directory exists
        run: mkdir -p assets
        shell: bash

      - name: Build CSS
        run: npm run build:css
        shell: bash

      - name: Cache Dioxus CLI
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/dx
            ~/.cargo/.crates.toml
            ~/.cargo/.crates2.json
          key: dioxus-cli-${{ runner.os }}-0.7.3

      - name: Install Dioxus CLI
        run: |
          if ! command -v dx >/dev/null 2>&1; then
            cargo install dioxus-cli --locked --version 0.7.3
          else
            echo "Dioxus CLI already installed"
          fi
        shell: bash

      - name: Build & Bundle (Linux)
        if: matrix.platform == 'linux'
        run: |
          export PKG_CONFIG_PATH=/usr/lib/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig
          dx bundle --release --platform desktop --package-types deb --package-types rpm
        shell: bash

      - name: Bundle (Windows)
        if: matrix.platform == 'windows'
        run: |
          dx bundle --release --platform desktop --package-types msi --verbose
        env:
          RUSTFLAGS: "-C link-arg=-fuse-ld=lld"
        shell: pwsh

      - name: Package (Linux)
        if: matrix.platform == 'linux'
        run: |
          mkdir -p release-artifacts

          # 1. Prepare Binary + Assets from Dioxus deb bundle staging output
          DEB_BUNDLE_DIR="target/dx/${APP_NAME}/bundle/linux/bundle/deb"
          DEB_DATA_DIR=$(find "$DEB_BUNDLE_DIR" -type d -path "*/data/usr" | head -1)
          if [ -z "$DEB_DATA_DIR" ]; then
            echo "Error: Dioxus deb data directory not found in: $DEB_BUNDLE_DIR"
            exit 1
          fi

          BINARY_FILE="${DEB_DATA_DIR}/bin/${APP_NAME}"
          ASSETS_DIR=$(find "${DEB_DATA_DIR}/lib" -type d -name assets | head -1)
          if [ ! -f "$BINARY_FILE" ]; then
            echo "Error: Bundled binary not found: $BINARY_FILE"
            exit 1
          fi
          if [ -z "$ASSETS_DIR" ] || [ ! -d "$ASSETS_DIR" ]; then
            echo "Error: Bundled assets not found under: ${DEB_DATA_DIR}/lib"
            exit 1
          fi

          cp "$BINARY_FILE" ./release-artifacts/${APP_NAME}

          # 2. Add Bundled Assets (hashed output + component CSS)
          cp -r "$ASSETS_DIR" "./release-artifacts/assets"

          # 3. Add Launcher Script
          if [ -f "./scripts/course-pilot-launcher.sh" ]; then
            cp ./scripts/course-pilot-launcher.sh ./release-artifacts/course-pilot-launcher
            chmod +x ./release-artifacts/course-pilot-launcher
          fi

          chmod +x "./release-artifacts/${APP_NAME}"
          strip "./release-artifacts/${APP_NAME}" || true

          # 4. Create Tarball
          tar -czf "${{ matrix.artifact }}" -C release-artifacts .

          # 5. Extract .deb (Search for any generated .deb in the target directory)
          DEB_PATH=$(find target -name "*.deb" | head -1)
          if [ -n "$DEB_PATH" ]; then
            cp "$DEB_PATH" "course-pilot-linux-x64.deb"
            echo "Successfully found and copied Debian package: $DEB_PATH"
          else
            echo "Warning: Debian package not found in target directory"
            exit 1
          fi

          # 6. Extract .rpm (Search for any generated .rpm in the target directory)
          RPM_PATH=$(find target -name "*.rpm" | head -1)
          if [ -n "$RPM_PATH" ]; then
            cp "$RPM_PATH" "course-pilot-linux-x64.rpm"
            echo "Successfully found and copied RPM package: $RPM_PATH"
          else
            echo "Warning: RPM package not found in target directory"
            exit 1
          fi
        shell: bash

      - name: Package (Windows)
        if: matrix.platform == 'windows'
        run: |
          $msi = Get-ChildItem -Path ./target -Filter "*.msi" -Recurse | Select-Object -First 1
          if ($msi) {
              Copy-Item $msi.FullName ./course-pilot-windows-x64.msi
          } else {
              Write-Error "MSI not found"
              exit 1
          }
        shell: pwsh

      - name: Upload Linux Tarball
        if: matrix.platform == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: linux-tarball
          path: course-pilot-linux-x64.tar.gz

      - name: Upload Linux Debian Package
        if: matrix.platform == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: course-pilot-linux-x64.deb

      - name: Upload Linux RPM Package
        if: matrix.platform == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: linux-rpm
          path: course-pilot-linux-x64.rpm

      - name: Upload Windows MSI
        if: matrix.platform == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: windows-msi
          path: course-pilot-windows-x64.msi

  release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Linux Tarball
        uses: actions/download-artifact@v4
        with:
          name: linux-tarball

      - name: Download Linux Debian Package
        uses: actions/download-artifact@v4
        with:
          name: linux-deb

      - name: Download Linux RPM Package
        uses: actions/download-artifact@v4
        with:
          name: linux-rpm

      # - name: Download Windows MSI
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: windows-msi

      - name: Compute checksums and sizes
        id: meta
        run: |
          set -euo pipefail
          linux_tar="course-pilot-linux-x64.tar.gz"
          linux_deb="course-pilot-linux-x64.deb"
          linux_rpm="course-pilot-linux-x64.rpm"
          # win_msi="course-pilot-windows-x64.msi"

          tar_size=$(du -h "$linux_tar" | cut -f1)
          deb_size=$(du -h "$linux_deb" | cut -f1)
          rpm_size=$(du -h "$linux_rpm" | cut -f1)
          # msi_size=$(du -h "$win_msi" | cut -f1)

          tar_sha=$(sha256sum "$linux_tar" | cut -d' ' -f1)
          deb_sha=$(sha256sum "$linux_deb" | cut -d' ' -f1)
          rpm_sha=$(sha256sum "$linux_rpm" | cut -d' ' -f1)
          # msi_sha=$(sha256sum "$win_msi" | cut -d' ' -f1)

          {
            echo "tar_size=$tar_size"
            echo "deb_size=$deb_size"
            echo "rpm_size=$rpm_size"
            # echo "msi_size=$msi_size"
            echo "tar_sha=$tar_sha"
            echo "deb_sha=$deb_sha"
            echo "rpm_sha=$rpm_sha"
            # echo "msi_sha=$msi_sha"
          } >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Prepare release notes
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME#v}"
          notes_file="release_notes.md"

          if [ -f CHANGELOG.md ]; then
            awk -v v="$version" '
              BEGIN {found=0}
              $0 ~ "^## \\[" v "\\]" {found=1; print; next}
              found && $0 ~ "^## \\[" {exit}
              found {print}
            ' CHANGELOG.md > "$notes_file"
          fi

          if [ ! -s "$notes_file" ]; then
            echo "## [${version}] - $(date -u +%Y-%m-%d)" > "$notes_file"
            echo "- Release ${GITHUB_REF_NAME}" >> "$notes_file"
          fi

          {
            echo ""
            echo "### ðŸ“¦ Downloads"
            echo "| Platform | File | Size | SHA256 |"
            echo "|----------|------|------|--------|"
            echo "| ðŸ§ Linux (Debian/Ubuntu) | course-pilot-linux-x64.deb | ${{ steps.meta.outputs.deb_size }} | ${{ steps.meta.outputs.deb_sha }} |"
            echo "| ðŸ§ Linux (RPM/Fedora) | course-pilot-linux-x64.rpm | ${{ steps.meta.outputs.rpm_size }} | ${{ steps.meta.outputs.rpm_sha }} |"
            echo "| ðŸ§ Linux (Generic/Arch) | course-pilot-linux-x64.tar.gz | ${{ steps.meta.outputs.tar_size }} | ${{ steps.meta.outputs.tar_sha }} |"
            # echo "| ðŸªŸ Windows x64 | course-pilot-windows-x64.msi | ${{ steps.meta.outputs.msi_size }} | ${{ steps.meta.outputs.msi_sha }} |"
            echo ""
            echo "### ðŸš€ Installation (Linux)"
            echo "- **Debian/Ubuntu/Mint**: Download the \`.deb\` and install via \`sudo apt install ./course-pilot-linux-x64.deb\`."
            echo "- **Fedora/RHEL**: Download the \`.rpm\` and install via \`sudo dnf install ./course-pilot-linux-x64.rpm\`."
            echo "- **Arch/Others**: Download the \`.tar.gz\`, extract it, and run \`course-pilot-launcher\`. This script will automatically check and help install dependencies."
            # echo ""
            # echo "### ðŸš€ Installation (Windows)"
            # echo "- **Windows 10/11**: Download the \`.msi\` and run the installer."
            echo ""
            echo "### âš™ï¸ System Requirements"
            echo "- **Linux**: Ubuntu 20.04+ / Debian 11+ / Fedora 35+ / Arch Linux (GTK3/4 compatible WebKit)"
            # echo "- **Windows**: Windows 10 (1903+) / Windows 11"
          } >> "$notes_file"
        shell: bash

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            course-pilot-linux-x64.tar.gz
            course-pilot-linux-x64.deb
            course-pilot-linux-x64.rpm
            # course-pilot-windows-x64.msi
          tag_name: ${{ github.ref_name }}
          name: Course Pilot ${{ github.ref_name }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
