name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: read

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  NODE_VERSION: "20"
  APP_NAME: course_pilot

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            artifact: course-pilot-linux-x64.tar.gz
            binary: course_pilot
          - os: windows-2022
            platform: windows
            artifact: course-pilot-windows-x64.zip
            binary: course_pilot.exe

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.platform == 'windows' && 'x86_64-pc-windows-msvc' || '' }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libxdo3 \
            libxdo-dev \
            patchelf \
            pkg-config \
            libglib2.0-dev \
            libgdk-pixbuf2.0-dev \
            libcairo2-dev \
            libpango1.0-dev \
            libatk1.0-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev \
            libgdk3.0-cil
        shell: bash

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install Node dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
        shell: bash

      - name: Ensure assets directory exists
        run: mkdir -p assets
        shell: bash

      - name: Build CSS
        run: npm run build:css
        shell: bash

      - name: Install Dioxus CLI
        run: cargo install dioxus-cli --locked --force
        shell: bash

      - name: Build & Bundle (Linux)
        if: matrix.platform == 'linux'
        run: |
          export PKG_CONFIG_PATH=/usr/lib/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig
          dx build --release --platform desktop
          dx bundle --release --platform desktop --package-types deb
        shell: bash

      - name: Build (Windows)
        if: matrix.platform == 'windows'
        run: |
          dx build --release --platform desktop
        env:
          RUSTFLAGS: "-C target-feature=+crt-static"
        shell: pwsh

      - name: Package (Linux)
        if: matrix.platform == 'linux'
        run: |
          mkdir -p release-artifacts

          # 1. Prepare Binary
          if [ -f "./target/dx/${APP_NAME}/release/linux/${APP_NAME}" ]; then
            cp "./target/dx/${APP_NAME}/release/linux/${APP_NAME}" ./release-artifacts/
          else
            find ./target -name "${APP_NAME}" -type f -executable | head -1 | xargs -I{} cp {} ./release-artifacts/
          fi

          # 2. Add Assets
          cp -r ./assets ./release-artifacts/

          # 3. Add Launcher Script
          cp ./scripts/course-pilot-launcher.sh ./release-artifacts/course-pilot-launcher
          chmod +x ./release-artifacts/course-pilot-launcher
          chmod +x "./release-artifacts/${APP_NAME}"
          strip "./release-artifacts/${APP_NAME}" || true

          # 4. Create Tarball
          tar -czf "${{ matrix.artifact }}" -C release-artifacts .

          # 5. Extract .deb from bundle directory
          DEB_FILE=$(find target/dx/${APP_NAME}/release/bundle/deb -name "*.deb" | head -1)
          if [ -n "$DEB_FILE" ]; then
            cp "$DEB_FILE" "course-pilot-linux-x64.deb"
          fi
        shell: bash

      - name: Package (Windows)
        if: matrix.platform == 'windows'
        run: |
          New-Item -ItemType Directory -Force -Path release-artifacts | Out-Null
          $locations = @(
            "./target/dx/${env:APP_NAME}/release/windows/${env:APP_NAME}.exe",
            "./target/release/${env:APP_NAME}.exe"
          )
          $found = $false
          foreach ($loc in $locations) {
            if (Test-Path $loc) {
              Copy-Item $loc ./release-artifacts/
              $found = $true
              break
            }
          }
          if (-not $found) {
            $exe = Get-ChildItem -Path ./target -Filter "${env:APP_NAME}.exe" -Recurse | Select-Object -First 1
            if ($exe) {
              Copy-Item $exe.FullName ./release-artifacts/
            } else {
              Write-Error "Binary not found"
              exit 1
            }
          }
          Copy-Item -Recurse ./assets ./release-artifacts/
          Compress-Archive -Path ./release-artifacts/* -DestinationPath "${{ matrix.artifact }}"
        shell: pwsh

      - name: Upload Linux Tarball
        if: matrix.platform == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: linux-tarball
          path: course-pilot-linux-x64.tar.gz

      - name: Upload Linux Debian Package
        if: matrix.platform == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: course-pilot-linux-x64.deb

      - name: Upload Windows artifact
        if: matrix.platform == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifact
          path: ${{ matrix.artifact }}

  release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Linux Tarball
        uses: actions/download-artifact@v4
        with:
          name: linux-tarball

      - name: Download Linux Debian Package
        uses: actions/download-artifact@v4
        with:
          name: linux-deb

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-artifact

      - name: Compute checksums and sizes
        id: meta
        run: |
          set -euo pipefail
          linux_tar="course-pilot-linux-x64.tar.gz"
          linux_deb="course-pilot-linux-x64.deb"
          windows_zip="course-pilot-windows-x64.zip"

          tar_size=$(du -h "$linux_tar" | cut -f1)
          deb_size=$(du -h "$linux_deb" | cut -f1)
          win_size=$(du -h "$windows_zip" | cut -f1)

          tar_sha=$(sha256sum "$linux_tar" | cut -d' ' -f1)
          deb_sha=$(sha256sum "$linux_deb" | cut -d' ' -f1)
          win_sha=$(sha256sum "$windows_zip" | cut -d' ' -f1)

          {
            echo "tar_size=$tar_size"
            echo "deb_size=$deb_size"
            echo "win_size=$win_size"
            echo "tar_sha=$tar_sha"
            echo "deb_sha=$deb_sha"
            echo "win_sha=$win_sha"
          } >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Prepare release notes
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME#v}"
          notes_file="release_notes.md"

          if [ -f CHANGELOG.md ]; then
            awk -v v="$version" '
              BEGIN {found=0}
              $0 ~ "^## \\[" v "\\]" {found=1; print; next}
              found && $0 ~ "^## \\[" {exit}
              found {print}
            ' CHANGELOG.md > "$notes_file"
          fi

          if [ ! -s "$notes_file" ]; then
            echo "## [${version}] - $(date -u +%Y-%m-%d)" > "$notes_file"
            echo "- Release ${GITHUB_REF_NAME}" >> "$notes_file"
          fi

          {
            echo ""
            echo "### ðŸ“¦ Downloads"
            echo "| Platform | File | Size | SHA256 |"
            echo "|----------|------|------|--------|"
            echo "| ðŸ§ Linux (Debian/Ubuntu) | course-pilot-linux-x64.deb | ${{ steps.meta.outputs.deb_size }} | ${{ steps.meta.outputs.deb_sha }} |"
            echo "| ðŸ§ Linux (Generic/Arch) | course-pilot-linux-x64.tar.gz | ${{ steps.meta.outputs.tar_size }} | ${{ steps.meta.outputs.tar_sha }} |"
            echo "| ðŸªŸ Windows x64 | course-pilot-windows-x64.zip | ${{ steps.meta.outputs.win_size }} | ${{ steps.meta.outputs.win_sha }} |"
            echo ""
            echo "### ðŸš€ Installation (Linux)"
            echo "- **Debian/Ubuntu/Mint**: Download the `.deb` and install via `sudo apt install ./course-pilot-linux-x64.deb`."
            echo "- **Arch/Others**: Download the `.tar.gz`, extract it, and run `course-pilot-launcher`. This script will automatically check and help install dependencies."
            echo ""
            echo "### âš™ï¸ System Requirements"
            echo "- **Linux**: Ubuntu 20.04+ / Debian 11+ / Fedora 35+ / Arch Linux (GTK3/4 compatible WebKit)"
            echo "- **Windows**: Windows 10 (1903+) / Windows 11"
          } >> "$notes_file"
        shell: bash

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            course-pilot-linux-x64.tar.gz
            course-pilot-linux-x64.deb
            course-pilot-windows-x64.zip
          tag_name: ${{ github.ref_name }}
          name: Course Pilot ${{ github.ref_name }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
